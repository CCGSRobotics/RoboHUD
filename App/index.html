<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="CSS/main.css">
    <script type="text/javascript" src="JS/main.js"></script>
    <!-- <script type="text/javascript" scr="JS/Resources/Player/server-tcp.js"></script>
    <script type="text/javascript" src="JS/client.js"></script> -->
    <script type="text/javascript">
      var net = require('net');
      var client = new net.Socket();
      var childProcess = require('child_process');
      // var pollGamepad = require('./JS/client.js').pollGamepad;
      var clientSocket = new net.Socket();

      function terminateConnection(connection) {
      	connection.write("010");
      	connection.write("020");
      	connection.write("030");
      	connection.write("040");
      }

      function axisValue(dynamixel, axis) {
      	var gamepad = navigator.getGamepads()[0];
      	var val = Math.round((gamepad.axes[axis]+1) * 512);

      	if (val < 0 || val > 1024) {
      		console.error("Controller value is out of bounds! (" + val + ")");
      	}

      	val = (val - 512) * -2;
      	if (dynamixel == 1 || dynamixel == 3) {
      		val = -val;
      	}
      	return val;
      }

      function sleep(ms) {
      	return new Promise(resolve => setTimeout(resolve, ms));
      }

      async function pollGamepad(interval) {
      	while (true) {
      		clientSocket.write('02' + axisValue(1, 3));
      		await sleep(interval);
      		clientSocket.write('01' + axisValue(2, 1));
      		await sleep(interval);
      		clientSocket.write('04' + axisValue(3, 3));
      		await sleep(interval);
      		clientSocket.write('03' + axisValue(4, 1));
      	}
      }

      function runScript(scriptPath, callback) {
          // keep track of whether callback has been invoked to prevent multiple invocations
          var invoked = false;
          var process = childProcess.fork(scriptPath);
          // listen for errors as they may prevent the exit event from firing
          process.on('error', function (err) {
              if (invoked) return;
              invoked = true;
              callback(err);
          });
          // execute the callback once the process has finished running
          process.on('exit', function (code) {
              if (invoked) return;
              invoked = true;
              var err = code === 0 ? null : new Error('exit code ' + code);
              callback(err);
          });
      }

      client.connect(5000, '192.168.100.1', function() {
        console.log("Connected to server interface");
      })

      function writeToServer(data) {
        client.write(data);
        console.log(`Wrote '${data}' to server`);
      }

      function start() {
        // console.log("test")
        writeToServer('START');
        // console.log("test 2")
        setTimeout(function() {
          clientSocket.connect(9999, '192.168.100.1', function() {
          	window.addEventListener("gamepadconnected", function(event) {
          		pollGamepad(130);
          	});
          });
          // runScript('./App/JS/client.js', function (err) {
          //     if (err) throw err;
          // });
        }, 3000)
        // // setTimeout(function() {
        // console.log('Starting client...');
        // var client = childProcess('./JS/client.js');
        // client.stdout.on('data', function (data) {
        //   console.log('stdout: ' + data.toString());
        // });
        // client.stderr.on('data', function (data) {
        //   console.log('stderr: ' + data.toString());
        // });
        // client.on('exit', function (code) {
        //   console.log('child process exited with code ' + code.toString());
        // });
          // runScript('./JS/Resources/server-tcp.js', function (err) {
          //     if (err) throw err;
          // });
          // //Opens camera feed
          // var iframe = document.createElement('iframe');
          // iframe.setAttribute('id', 'camera-view');
          // iframe.setAttribute('src', 'http://localhost:8080');
          // iframe.setAttribute('width', '1000');
          // iframe.setAttribute('height', '625');
          // var markerPoint = document.getElementById('marker');
          // markerPoint.parentNode.insertBefore(iframe, markerPoint);
        // }, 3000)
      }
    </script>
    <script type="text/javascript">
      // execute('node App/JS/Resources/Player/server-tcp.js');
    </script>
  </head>
  <body>
    <div id="sidenav">
      <a href="index.html" id="selected">Dashboard</a>
      <a href="camera.html">Camera</a>
      <a href="control.html">Robot Control</a>
      <a href="testing.html">Testing</a>
      <a href="settings.html">Settings</a>
      <a href="version.html">Version</a>
    </div>
    <div class="main">
        <h1 class="text" id="main-header">Dashboard - Robotics GUI</h1>
        <button type="button" name="button" onclick="start()" id="start">Start</button>
        <p id="marker"></p>
    </div>
  </body>
</html>
