<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="CSS/main.css">
    <script type="text/javascript" src="JS/main.js"></script>
    <script type="text/javascript">
      var net = require('net');
      var dgram = require('dgram');
      var client = new net.Socket();
      var childProcess = require('child_process');
      var clientSocket = new dgram.createSocket('udp4');
      var jointSpeed = 500;
      var direction = 5270;
      var stopped = [true, true, true, true, true, true, true, true, true, true, true, true, true, true, true]
      var video;
      var leftCameraButton = 14;
      var rightCameraButton = 15;

      function terminateConnection(connection) {
      	connection.write('010');
      	connection.write('020');
      	connection.write('030');
      	connection.write('040');
      }

      function cameraPan(dynamixel, button, gamepad, step, speed) {
        var movementSpeed;

        // if (gamepad.buttons[leftCameraButton].pressed || gamepad.buttons[rightCameraButton].pressed) {
          movementSpeed = speed;

          if (gamepad.buttons[leftCameraButton].pressed && direction < (8570 - step)) {
            stopped[button] = false;
            direction += step;
          } else if (gamepad.buttons[rightCameraButton].pressed  && direction > (1670 + step)) {
            stopped[button] = false;
            direction -= step;
          } else if (stopped[button] == false){
          stopped[button] = true;
          return `0${dynamixel}${direction}${500}`
        }
        return `0${dynamixel}${direction}${movementSpeed}`
      }

      // function buttonValue(dynamixel, button, gamepad, step, speed) {
      //   var movementSpeed;
      //
      //   if (gamepad.buttons[button].pressed) {
      //     movementSpeed = speed
      //
      //     if (dynamixel == 7) {
      //       if (button == leftCameraButton) {
      //         if (direction < (8570 - step)) {
      //           stopped[button] = false
      //           direction += step
      //         }
      //       } else if (button == rightCameraButton) {
      //         if (direction > (190 + step)) {
      //           stopped[button] = false
      //           direction -= step
      //         }
      //       }
      //     }
      //   } else if (stopped[button] == false){
      //     stopped[button] = true;
      //     return `0${dynamixel}${direction}${500}`
      //   }
      //   return `0${dynamixel}${direction}${movementSpeed}`
      // }

      function axisValue(dynamixel, axis, gamepad) {
      	var val = Math.round((gamepad.axes[axis]+1) * 512);

      	if (val < 0 || val > 1024) {
      		console.error("Controller value is out of bounds! (" + val + ")");
      	}

      	val = (val - 512) * -2;
      	if (dynamixel == 1 || dynamixel == 3) {
      		val = -val;
      	}
      	return val;
      }

      function sleep(ms) {
      	return new Promise(resolve => setTimeout(resolve, ms));
      }

      async function writeStartingValues(interval) {
        clientSocket.send("0502000200", 9999, '192.168.100.1');
        await sleep(interval);
        clientSocket.send("0602000200", 9999, '192.168.100.1');
        await sleep(interval);
        clientSocket.send("0705120512", 9999, '192.168.100.1');
        await sleep(interval);
      }

      async function pollGamepad(gamepad) {
          var gamepad = navigator.getGamepads()[0];
          var wheel1 = axisValue(1, 3, gamepad)
          var wheel3 = axisValue(3, 3, gamepad)
          var wheel2 = axisValue(2, 1, gamepad)
          var wheel4 = axisValue(2, 1, gamepad)
          var cameraPanValue = cameraPan(7, leftCameraButton, gamepad, 300, jointSpeed)

      		clientSocket.send('02' + wheel1, 9999, '192.168.100.1');
      		// await sleep(interval);
          clientSocket.send('04' + wheel3, 9999, '192.168.100.1');
      		// await sleep(interval);
      		clientSocket.send('01' + wheel2, 9999, '192.168.100.1');
      		// await sleep(interval);
      		clientSocket.send('03' + wheel4, 9999, '192.168.100.1');
          // await sleep(interval)
          clientSocket.send(cameraPanValue, 9999, '192.168.100.1');
          // await sleep(interval)
          // clientSocket.send(rightCamera);
          // await sleep(interval)
      }

      function runScript(scriptPath, callback) {
          var invoked = false;
          var process = childProcess.fork(scriptPath);
          process.on('error', function (err) {
              if (invoked) return;
              invoked = true;
              callback(err);
          });
      }

      client.connect(5000, '192.168.100.1', function() {
        console.log("Connected to server interface");
      })

      function writeToServer(data) {
        client.write(data);
        console.log(`Wrote '${data}' to server`);
      }

      setTimeout(function() {
        writeToServer('VIDEO')
        video = childProcess.fork('App/JS/Resources/Player/server-tcp.js');
        video.on('error', function(err) {
          console.error(`Video error: ${err}`)
        })
        setTimeout(function() {
          var iframe = document.createElement('iframe');
          iframe.setAttribute('id', 'camera-view');
          iframe.setAttribute('src', 'http://localhost:8080');
          iframe.setAttribute('width', '1000');
          iframe.setAttribute('height', '625');
          var markerPoint = document.getElementById('marker');

          markerPoint.parentNode.insertBefore(iframe, markerPoint);
        }, 1000)
        writeToServer('START');
        setTimeout(async function() {
          // clientSocket.connect(9999, '192.168.100.1', async function() {
            await writeStartingValues(30)
            let gamepadInterval;
            window.addEventListener("gamepadconnected", function(event) {
          		gamepadInterval = setInterval(pollGamepad, 30, event.gamepad);
          	});
          // });
        }, 3000)
      }, 3000)
    </script>
  </head>
  <body>
    <div class="main">
        <h1 class="text" id="main-header">Dashboard - Robotics GUI</h1>
        <p id="marker"></p>
    </div>
  </body>
</html>
